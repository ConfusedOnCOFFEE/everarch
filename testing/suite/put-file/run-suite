#!/bin/bash
set -e
. ../config

stop(){
    kill -s sigint "${spid}"
    wait "${spid}" || true
    if [[ -e 'storage/lock' ]]
    then
        echo "storage/lock still existing after storage quit" >&2
        exit 1
    fi
    rm -rf 'storage' 'files'
}

rm -rf 'storage' 'files'
mkdir 'storage' 'files'

echo 'hello world!' > './files/hello.txt'

evr-glacier-storage &
spid=$!
trap stop EXIT

test_file_put_pop(){
    local base_name="$1"
    echo "Testing put/pop ${base_name}â€¦"
    ref=`evr post-file "files/${base_name}.txt"`
    echo "evr reported ref ${ref}"
    echo "evr get-file ${ref}"
    evr get-file "${ref}" > "files/${base_name}.get.txt"
    echo "Comparing ${base_name} posted with get file"
    diff "files/${base_name}.txt" "files/${base_name}.get.txt"
    echo "${base_name} file looks good"
}

wait_for_glacier_storage

test_file_put_pop "hello"

# produce a 32mb file
dd if=/dev/random bs=4096 count=8192 of=files/big.txt
test_file_put_pop "big"

# it should use custom title if -t arg present
ref=`evr post-file -t 'my file name' 'files/hello.txt' | sed 's/\(sha3-.*\)-[a-z0-9]\{4\}/\1/'`
claim=`evr get ${ref}`
if [[ "${claim}" != *"my file name"* ]]
then
    echo "Claim should have used title 'my file name': ${claim}" >&2
    exit 1
fi

# it should read from stdin if file argument is missing
ref=`echo 'piped content' | evr post-file`
content=`evr get-file ${ref}`
if [[ 'piped content' != "${content}" ]]
then
    echo "Expected 'piped content' but got: ${content}" >&2
    exit 1
fi

# evr get-claim
claim=`evr get-claim ${ref}`
if [[ "${claim}" != "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<file xmlns=\"https://evr.ma300k.de/claims/\">
  <body>
   <slice ref=\"sha3-224-0890c2f681f23e2c67aa9f9685cf753be459f460b4ee8404752aa449\" size=\"14\"/>
  </body>
 </file>" ]]
then
    echo "Retrieved unexpected claim: ${claim}" >&2
    exit 1
fi
